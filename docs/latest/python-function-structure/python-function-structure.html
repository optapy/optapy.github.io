<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python Function Structure :: Documentation</title>
    <link rel="canonical" href="https://www.optapy.org/docs/latest/python-function-structure/python-function-structure.html">
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="stylesheet" href="../../../_/css/menu.css"><!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 1/2 -->
<script id="dpal" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
<!-- Google Analytics for kie team: Global site tag (gtag.js) -->
<script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://www.optapy.org">
          <img src="../../../_/img/optaPyLogoDarkBackground200px.png" alt="OptaPy logo"/>
        </a>
        <a class="navbar-item" href="https://www.optapy.org">
          Documentation
        </a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/optapy">Get Help</a>
        <div class="navbar-item">
          <a class="navbar-item small-item" href="https://github.com/optapy/optapy" title="Follow OptaPy on GitHub"><img src="https://img.shields.io/github/stars/optapy/optapy?style=flat&logo=github" alt="GitHub" /></a>
          <a class="navbar-item small-item" href="https://twitter.com/OptaPlanner" target="_blank" title="Follow OptaPlanner on Twitter"><img alt="T" src="../../../_/img/twitterLogo.png"></a>
          <a class="navbar-item small-item" href="https://www.linkedin.com/showcase/optaplanner" target="_blank" title="Follow OptaPlanner on LinkedIn"><img alt="L" src="../../../_/img/linkedInLogo.png"></a>
          <a class="navbar-item small-item" href="https://www.facebook.com/OptaPlanner" target="_blank" title="Follow OptaPlanner on Facebook"><img alt="F" src="../../../_/img/facebookLogo.png"></a>
          <a class="navbar-item small-item" href="https://www.youtube.com/channel/UCcpkOKpujFlM67D2h0RdaeQ" target="_blank" title="OptaPlanner YouTube channel"><img alt="YT" src="../../../_/img/youtubeLogo.png" style="height: 16px"></a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OptaPy User Guide 9.37.0b0</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">User Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../planner-introduction/planner-introduction.html">OptaPy Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../planner-configuration/planner-configuration.html">OptaPy configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../score-calculation/score-calculation.html">Score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../constraint-streams/constraint-streams.html">Constraint streams score calculation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../shadow-variable/shadow-variable.html">Shadow variable</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../optimization-algorithms/optimization-algorithms.html">Optimization algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../move-and-neighborhood-selection/move-and-neighborhood-selection.html">Move and neighborhood selection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../exhaustive-search/exhaustive-search.html">Exhaustive search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../construction-heuristics/construction-heuristics.html">Construction heuristics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../local-search/local-search.html">Local search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../evolutionary-algorithms/evolutionary-algorithms.html">Evolutionary algorithms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../partitioned-search/partitioned-search.html">Partitioned search</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../repeated-planning/repeated-planning.html">Repeated planning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../design-patterns/design-patterns.html">Design patterns</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Developer Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../jpyinterpreter-introduction/jpyinterpreter-introduction.html">JPyInterpreter Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../stack-machines/stack-machines.html">Stack Machines Introduction</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="python-function-structure.html">Python Function Structure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../opcodes/opcodes.html">CPython Opcode Instructions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../java-bytecode/java-bytecode.html">Java Bytecode</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../jpyinterpreter-architecture/jpyinterpreter-architecture.html">JPyInterpreter Architecture</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OptaPy User Guide 9.37.0b0</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OptaPy User Guide 9.37.0b0</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../planner-introduction/planner-introduction.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OptaPy User Guide 9.37.0b0</a></li>
    <li>Developer Guide</li>
    <li><a href="python-function-structure.html">Python Function Structure</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/optapy/optapy/edit/main/optapy-docs/src/modules/ROOT/pages/python-function-structure/python-function-structure.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Python Function Structure</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In Python, the details about a function, including
its implementation and argument spec, are accessible
from the <a href="https://docs.python.org/3.11/reference/datamodel.html#index-33">function object</a>.
In <code>jpyinterpreter</code>, this information is stored in the class <code>PythonCompiledFunction</code>.
It has several attributes. In particular, we are interested in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>__globals__</code>: The globals dict that is used by the function. All classes defined in the same file share the same globals. Classes defined in different files have different globals. All globals variables are stored in this dict.</p>
</li>
<li>
<p><code>__closure__</code>: Variables used by the function that were declared in an outer scope. for instance:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def outer():
    x = 10
    def inner():
        return x
    return inner</code></pre>
</div>
</div>
<div class="paragraph">
<p>the function <code>inner.__closure__</code> would be <code>[Cell(value=10)]</code>. Cells are used because changes in the outer function affects the inner function. For instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def outer():
    x = 10
    def inner():
        return x
    x = 20
    return inner()  # returns 20</code></pre>
</div>
</div>
</li>
<li>
<p><code>__defaults__</code>: contains default values for "allow-positional" arguments. For example, for the function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def my_function(a, pos_only=1, / , allow_pos=2, * , keyword_only=3):
    pass</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>__defaults__</code> would be <code>(1, 2)</code>. Keyword-only default arguments are instead stored in <code>__kwdefaults__</code>, which for the above function would be <code>{'keyword_only': 3}</code>.</p>
</div>
</li>
<li>
<p><code>__qualname__</code>: the <a href="https://docs.python.org/3.11/glossary.html#term-qualified-name">qualified name</a> of the function.</p>
</li>
<li>
<p><code>__annotations__</code>: the type annotations of the function. For example, for the function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def typed_function(a: int, b: str) -&gt; 'A':
    return A(a, b)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>__annotations__</code> would be <code>{'a': int, 'b': str, 'return': 'A'}</code>. Values in the <code>__annotations__</code> dict should be a type or a string. If it is a string, it represents the type that has the same name as that string.</p>
</div>
</li>
<li>
<p><code>__code__</code>: The code object of the function, containing the function bytecode and argument spec. Code objects are described below.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code_objects"><a class="anchor" href="#_code_objects"></a>Code Objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.python.org/3.11/reference/datamodel.html#index-55">Code objects</a> is the byte-compiled Python function. The primary difference between function objects and code objects is that function objects contain context (i.e. globals, defaults, closure) whereas code objects are context-free. Of its attributes, we are interested in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>co_names</code>: A tuple of names used by the bytecode. For instance, the function</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def my_function():
    a = 1
    b = 2
    return max(a, b)</code></pre>
</div>
</div>
<div class="paragraph">
<p>has <code>('a', 'b', 'max')</code> in its <code>co_names</code> attribute. It is referenced by the bytecode to load and store globals. For example, <code>LOAD_GLOBAL 2</code> means "load the global with the name given by the entry in co_names at index 2" (i.e. <code>max</code>).</p>
</div>
</li>
<li>
<p><code>co_varnames</code>: a tuple of variable names used by the bytecode (including parameters). For instance, the function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def outer_function(outer_parameter):
    def inner_function(inner_parameter):
        my_local = outer_parameter + inner_parameter
        return my_local * 2
    return inner_function</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>inner_function&#8217;s</code>  <code>co_varnames</code> would be <code>('inner_parameter', 'my_local',  'outer_parameters')</code>. <code>co_varnames</code> always starts with the function&#8217;s parameter, followed by local variables used in the function, followed by cell variables used in the function. Cell variables are variables that are stored in a cell. There are two types: free variables, which is a cell from an outer function (in this case, <code>outer_parameter</code> is a free variable of <code>inner_function</code>), and bound variables, which is a cell that is used in an inner function (in this case, <code>outer_parameter</code> is a bound variable of <code>outer_function</code>).</p>
</div>
</li>
<li>
<p><code>co_cellvars</code>: a tuple of strings representing bound variable.</p>
</li>
<li>
<p><code>co_freevars</code>: a tuple of strings representing free variable.</p>
</li>
<li>
<p><code>co_constants</code>: a tuple of constants used in the function. For instance, the function:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def my_function():
    a = 1
    b = 2
    return a + b</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>co_constants</code> would be <code>(1, 2)</code>. In CPython, objects
eligible to be constants are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>int</code> objects (ex: <code>1</code>, <code>42</code>)</p>
</li>
<li>
<p><code>float</code> objects (ex: <code>1.5</code>, <code>NaN</code>)</p>
</li>
<li>
<p><code>bool</code> objects (<code>True</code> and <code>False</code>)</p>
</li>
<li>
<p><code>str</code> objects (ex: <code>'hello world'</code>)</p>
</li>
<li>
<p><code>bytes</code> objects (ex: <code>b&#8217;hello world'</code>)</p>
</li>
<li>
<p><code>None</code> (<code>None</code>)</p>
</li>
<li>
<p><code>Ellipsis</code> (<code>&#8230;&#8203;</code>)</p>
<div class="paragraph">
<p>The following objects are not eligible to be used as constants, and are loaded with <code>LOAD_GLOBAL</code> instead:</p>
</div>
</li>
<li>
<p><code>class</code> objects (ex: <code>int</code>, <code>str</code>, user defined classes)</p>
</li>
<li>
<p><code>function</code> objects (ex: <code>max</code>, <code>range</code>, user defined functions)</p>
</li>
<li>
<p>Instances of user defined classes</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>co_exceptiontable</code>: a mapping from bytecode instruction ranges to their exception handler.
The exception handler have the following properties:</p>
<div class="ulist">
<ul>
<li>
<p><code>targetInstruction</code>: the bytecode index to jump to</p>
</li>
<li>
<p><code>stackDepth</code>: the stack depth prior to the try block (required for restoring the stack state)</p>
</li>
<li>
<p><code>pushLastIndex</code>: A boolean, that if true, indicates the handler should push the bytecode index that raised the exception prior to pushing the exception (otherwise, only the exception is pushed).</p>
<div class="paragraph">
<p>This attribute is only present in Python 3.11 and above; previous versions of Python use bytecode instruction to push and pop exception blocks.
 For example, the function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def my_function():
    for x in range(10):
        try:
            y = other_function_1(x)
            try:
                other_function_2(x, y)
            except:
                print('other 2 exception')
        except:
            print('other 1 exception')</code></pre>
</div>
</div>
<div class="paragraph">
<p>would have (simplified) bytecode looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">0  LOAD_GLOBAL 0 (range)
1  LOAD_CONSTANT 1 (10)
2  CALL 1
3  GET_ITER
4  FOR_ITER 19 (23 LOAD_CONSTANT)
5  STORE_LOCAL 0 (x)
6  LOAD_GLOBAL 1 (other_function_1)
7  LOAD_LOCAL 0 (x)
8  CALL 1
9  STORE_LOCAL 1 (y)
10 LOAD_GLOBAL 2 (other_function_2)
11 LOAD_LOCAL 0 (x)
12 LOAD_LOCAL 1 (y)
13 CALL 2
14 JUMP_BACKWARDS 10 (4 FOR_ITER)
15 POP_TOP
16 LOAD_GLOBAL 3 (print)
17 LOAD_CONSTANT 2 ('other 2 exception')
18 JUMP_BACKWARDS 14 (4 FOR_ITER)
19 POP_TOP
20 LOAD_GLOBAL 3 (print)
21 LOAD_CONSTANT 2 ('other 1 exception')
22 JUMP_BACKWARDS 18 (4 FOR_ITER)
23 LOAD_CONSTANT 0 (None)
24 RETURN</code></pre>
</div>
</div>
<div class="paragraph">
<p>For simplicity, the code that handles exceptions in exception handlers has been excluded. The above bytecode would have the corresponding exception table below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Exception Table:
[12, 14) -&gt; 15 (stack-depth: 1)
[5,  18) -&gt; 19 (stack-depth: 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Stack depth is 1 because the iterator was on the stack prior to the try block.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>co_argcount</code> the number of allow-positional arguments the function takes. For example, for the function below:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">def my_function(a, b, /, c, d=10, *, e=20):
    pass</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>co_argcount</code> would be <code>4</code>, since <code>a</code>, <code>b</code>, <code>c</code>, and <code>d</code> can be specified as a positional argument (<code>a</code>, <code>b</code> are required positional only arguments,
<code>c</code> is a positional-or-keyword required argument,
<code>d</code> is a positional-or-keyword optional argument,
<code>e</code> is a keyword-only optional argument).</p>
</div>
</li>
<li>
<p><code>co_kwonlyargcount</code> is the number of keyword-only arguments.
For the example given in <code>co_argcount</code>, it would be <code>1</code>, since <code>e</code> is the only keyword-only argument.</p>
</li>
<li>
<p><code>co_posonlyargcount</code> is the number of positional-only arguments.
For the example given in <code>co_argcount</code>, it would be <code>2</code>, since <code>a</code> and <code>b</code> are the only positional-only arguments.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>

<!-- Adobe Analytics for Red Hat - DPAL (DTM Property Auto-Loader) - part 2/2 -->
<script type="text/javascript">
    if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
        _satellite.pageBottom();
    }
</script>  </body>
</html>
